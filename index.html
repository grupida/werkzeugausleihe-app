<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Werkzeugausleihe v4.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #9333ea 0%, #1a1a1a 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #7c3aed 0%, #000000 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.8em;
        }
        
        .mode-toggle {
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background: #9333ea;
            color: white;
        }
        
        .btn-secondary {
            background: #4b5563;
            color: white;
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 0.85em;
        }
        
        .content {
            padding: 20px 30px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .dashboard-card {
            background: linear-gradient(135deg, #7c3aed 0%, #1f2937 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .dashboard-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .dashboard-card p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .dashboard-card.alert {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        }
        
        .search-bar {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        
        input[type="text"],
        input[type="password"],
        input[type="date"],
        textarea,
        select {
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 0.95em;
        }
        
        input[type="text"],
        select {
            flex: 1;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        table th {
            background: #f5f5f5;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #ddd;
            font-weight: bold;
            color: #333;
        }
        
        table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        
        table tr:hover {
            background: #f9f9f9;
        }
        
        table tr.overdue {
            background: #ffebee;
        }
        
        table tr.overdue:hover {
            background: #ffcdd2;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .badge-available {
            background: #4caf50;
            color: white;
        }
        
        .badge-reserved {
            background: #ff9800;
            color: white;
        }
        
        .badge-ausgeliehen {
            background: #f44336;
            color: white;
        }
        
        .badge-returned {
            background: #9e9e9e;
            color: white;
        }
        
        .badge-overdue {
            background: #d32f2f;
            color: white;
            animation: pulse 2s infinite;
        }
        
        .badge-defekt {
            background: #424242;
            color: white;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .kategorie-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.75em;
            background: #e9d5ff;
            color: #7c3aed;
            margin-right: 5px;
        }
        
        .warenkorb {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #9333ea;
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .warenkorb:hover {
            transform: scale(1.05);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            margin: 20px;
        }
        
        .modal-content h2 {
            margin-bottom: 15px;
            color: #9333ea;
            font-size: 1.5em;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 0.9em;
        }
        
        .section {
            margin-top: 30px;
        }
        
        .section h2, .section h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
            color: #9333ea;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.3em;
            color: #9333ea;
        }
        
        .error {
            background: #ffebee;
            border: 2px solid #f44336;
            color: #c62828;
            padding: 12px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .info {
            background: #f3e8ff;
            border: 2px solid #9333ea;
            color: #6b21a8;
            padding: 12px;
            border-radius: 5px;
            margin: 15px 0;
            text-align: center;
            font-size: 0.9em;
        }
        
        .success-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            font-weight: bold;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 8px 16px;
            background: #9333ea;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .toolbar {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-bar select,
        .filter-bar input {
            flex: 1;
            min-width: 150px;
        }
        
        .history-item {
            padding: 8px;
            border-left: 3px solid #9333ea;
            margin-bottom: 8px;
            background: #f9f9f9;
            font-size: 0.85em;
        }
        
        .history-item strong {
            color: #9333ea;
        }
        
        .werkzeug-foto {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
        }
        
        .date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .foto-preview-container {
            position: relative;
            display: inline-block;
            margin-top: 10px;
        }
        
        .foto-preview-container img {
            max-width: 200px;
            border-radius: 5px;
            display: block;
        }
        
        .foto-remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .qr-code-container {
            text-align: center;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-top: 10px;
        }
        
        .qr-code-container canvas {
            margin: 0 auto;
        }
        
        .damage-report {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        
        .damage-report strong {
            color: #e65100;
        }
        
        /* Buchungskalender */
        .kalender-wrapper {
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .kalender-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        .kalender-table th {
            background: #7c3aed;
            color: white;
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #6b21a8;
            font-size: 0.85em;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .kalender-table th:first-child {
            text-align: left;
            min-width: 180px;
            max-width: 180px;
        }
        
        .kalender-table th.today {
            background: #1976d2;
        }
        
        .kalender-table td {
            border: 1px solid #e0e0e0;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
            min-width: 40px;
            max-width: 40px;
            height: 50px;
            position: relative;
        }
        
        .kalender-table td:first-child {
            text-align: left;
            font-weight: bold;
            background: #f9f9f9;
            min-width: 180px;
            max-width: 180px;
            padding: 8px 12px;
        }
        
        .kalender-table td.today {
            background: #e3f2fd;
        }
        
        .kalender-table td.weekend {
            background: #fafafa;
        }
        
        .kalender-werkzeug-name {
            display: block;
            font-size: 0.9em;
        }
        
        .kalender-werkzeug-inv {
            display: block;
            font-size: 0.75em;
            color: #666;
            margin-top: 2px;
        }
        
        .kalender-day-header {
            display: block;
            font-size: 0.7em;
            font-weight: normal;
            opacity: 0.9;
        }
        
        .kalender-day-number {
            display: block;
            font-size: 1.1em;
        }
        
        .kalender-cell-content {
            font-size: 0.7em;
            font-weight: bold;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            display: inline-block;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .kalender-cell-content.reserviert {
            background: #ff9800;
        }
        
        .kalender-cell-content.ausgeliehen {
            background: #f44336;
        }
        
        .kalender-cell-content.zurueckgegeben {
            background: #9e9e9e;
        }
        
        .kalender-legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            font-size: 0.85em;
        }
        
        .kalender-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .kalender-legend-box {
            width: 20px;
            height: 12px;
            border-radius: 2px;
        }
        
        .kalender-legend-box.reserviert {
            background: #ff9800;
        }
        
        .kalender-legend-box.ausgeliehen {
            background: #f44336;
        }
        
        .kalender-legend-box.zurueckgegeben {
            background: #9e9e9e;
        }
        
        /* Print Styles f√ºr QR-Code */
        @media print {
            body * {
                visibility: hidden;
            }
            #qrModal, #qrModal * {
                visibility: visible;
            }
            #qrModal {
                position: absolute;
                left: 0;
                top: 0;
                background: white;
            }
            .modal-content {
                box-shadow: none;
                max-width: 100%;
                padding: 20px;
            }
            button {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî® Werkzeugausleihe v4.0</h1>
            <div class="mode-toggle">
                <button id="mitarbeiterBtn" class="btn-primary" onclick="switchMode('mitarbeiter')">Mitarbeiter</button>
                <button id="adminBtn" class="btn-secondary" onclick="switchMode('admin')">Admin</button>
            </div>
        </div>
        
        <div class="content">
            <div id="loadingState" class="loading">
                <div>‚è≥ Lade Datenbank...</div>
            </div>
            
            <div id="errorState" class="hidden">
                <div class="error">
                    <strong>‚ùå Fehler beim Laden:</strong>
                    <p id="errorMessage"></p>
                    <button class="btn-primary" onclick="location.reload()">Neu laden</button>
                </div>
            </div>
            
            <div id="appContent" class="hidden">
                <!-- Mitarbeiter Modus -->
                <div id="mitarbeiterMode">
                    <div class="info" style="margin-bottom: 15px;">
                        <strong>üìÖ Verf√ºgbarkeitspr√ºfung:</strong> W√§hle deinen gew√ºnschten Entleihzeitraum, um nur verf√ºgbare Werkzeuge zu sehen.
                    </div>
                    
                    <div class="filter-bar" style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            Von:
                            <input type="date" id="mitarbeiterVon" onchange="filterWerkzeugeByAvailability()">
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            Bis:
                            <input type="date" id="mitarbeiterBis" onchange="filterWerkzeugeByAvailability()">
                        </label>
                        <button class="btn-secondary btn-small" onclick="clearMitarbeiterDateFilter()">Filter zur√ºcksetzen</button>
                    </div>
                    
                    <div class="search-bar">
                        <input type="text" id="searchInput" placeholder="Werkzeug suchen..." onkeyup="filterWerkzeuge()">
                        <select id="kategorieFilter" onchange="filterWerkzeuge()">
                            <option value="">Alle Kategorien</option>
                        </select>
                    </div>
                    
                    <h2>Verf√ºgbare Werkzeuge</h2>
                    <table id="werkzeugTable">
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>Werkzeug</th>
                                <th>Kategorie</th>
                                <th>Inv.-Nr.</th>
                                <th>Beschreibung</th>
                                <th>Zustand</th>
                                <th>Status</th>
                                <th>Aktion</th>
                            </tr>
                        </thead>
                        <tbody id="werkzeugBody"></tbody>
                    </table>
                    <div id="emptyWerkzeuge" class="empty-state hidden">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>Noch keine Werkzeuge vorhanden</h3>
                        <p>Wechsle zum Admin-Modus, um Werkzeuge hinzuzuf√ºgen.</p>
                    </div>
                    
                    <div class="section">
                        <h2>Alle Reservierungen</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Werkzeug</th>
                                    <th>Inv.-Nr.</th>
                                    <th>Mitarbeiter</th>
                                    <th>Von</th>
                                    <th>Bis</th>
                                    <th>Status</th>
                                    <th>Reserviert am</th>
                                    <th>Aktion</th>
                                </tr>
                            </thead>
                            <tbody id="meineReservierungen"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Admin Modus -->
                <div id="adminMode" class="hidden">
                    <div id="adminLogin">
                        <h2>Admin-Login</h2>
                        <div class="form-group">
                            <label>Passwort:</label>
                            <input type="password" id="adminPassword" onkeyup="if(event.key === 'Enter') adminLogin()">
                        </div>
                        <button class="btn-primary" onclick="adminLogin()">Einloggen</button>
                    </div>
                    
                    <div id="adminPanel" class="hidden">
                        <h2>Dashboard</h2>
                        <div class="dashboard" id="dashboard"></div>
                        
                        <div class="toolbar" style="margin-top: 20px;">
                            <button class="btn-primary" onclick="showWerkzeugverwaltung()">üîß Werkzeugverwaltung</button>
                            <button class="btn-secondary" onclick="showBuchungskalender()">üìÖ Buchungskalender</button>
                        </div>
                        
                        <div id="werkzeugverwaltungView">
                        <h2>Werkzeugverwaltung</h2>
                        
                        <div class="toolbar">
                            <button class="btn-success" onclick="showAddWerkzeugModal()">+ Werkzeug hinzuf√ºgen</button>
                            <label class="file-input-label" for="excelImport">üìÑ Excel importieren</label>
                            <input type="file" id="excelImport" accept=".csv,.xlsx" onchange="importExcel(event)">
                            <button class="btn-secondary" onclick="exportData()">üíæ Daten exportieren</button>
                        </div>
                        
                        <div class="info">
                            <strong>üí° CSV-Import:</strong> Format: <code>Werkzeug,Beschreibung,Zustand,Inventarnummer,Kategorie</code> (UTF-8)
                        </div>
                        
                        <h3>Alle Werkzeuge</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Foto</th>
                                    <th>Werkzeug</th>
                                    <th>Kategorie</th>
                                    <th>Inv.-Nr.</th>
                                    <th>Lagerplatz</th>
                                    <th>Beschreibung</th>
                                    <th>Zustand</th>
                                    <th>Status</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="adminWerkzeugBody"></tbody>
                        </table>
                        <div id="emptyAdminWerkzeuge" class="empty-state hidden">
                            <div class="empty-state-icon">üîß</div>
                            <h3>Noch keine Werkzeuge</h3>
                        </div>
                        
                        <div class="section">
                            <h3>Reservierungen & Ausleihen</h3>
                            
                            <div class="filter-bar">
                                <select id="filterStatus" onchange="filterAusleihen()">
                                    <option value="">Alle Status</option>
                                    <option value="reserviert">Reserviert</option>
                                    <option value="ausgeliehen">Ausgeliehen</option>
                                    <option value="zurueckgegeben">Zur√ºckgegeben</option>
                                </select>
                                <input type="text" id="filterMitarbeiter" placeholder="Mitarbeiter suchen..." onkeyup="filterAusleihen()">
                                <input type="text" id="filterWerkzeug" placeholder="Werkzeug suchen..." onkeyup="filterAusleihen()">
                                <button class="btn-secondary btn-small" onclick="resetFilter()">Filter zur√ºcksetzen</button>
                            </div>
                            
                            <table>
                                <thead>
                                    <tr>
                                        <th>Werkzeug</th>
                                        <th>Lagerplatz</th>
                                        <th>Mitarbeiter</th>
                                        <th>Von/Bis</th>
                                        <th>Status</th>
                                        <th>History</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody id="alleAusleihen"></tbody>
                            </table>
                        </div>
                        
                        <div class="section">
                            <h3>Schadensmeldungen</h3>
                            <div id="schadensberichte"></div>
                        </div>
                        </div>
                        
                        <!-- Buchungskalender View -->
                        <div id="buchungskalenderView" class="hidden">
                            <h2>üìÖ Buchungskalender</h2>
                            
                            <div class="filter-bar">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    Jahr:
                                    <select id="kalenderJahr" onchange="loadBuchungskalender()">
                                        <!-- Wird dynamisch bef√ºllt -->
                                    </select>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    Monat:
                                    <select id="kalenderMonat" onchange="loadBuchungskalender()">
                                        <option value="0">Januar</option>
                                        <option value="1">Februar</option>
                                        <option value="2">M√§rz</option>
                                        <option value="3">April</option>
                                        <option value="4">Mai</option>
                                        <option value="5">Juni</option>
                                        <option value="6">Juli</option>
                                        <option value="7">August</option>
                                        <option value="8">September</option>
                                        <option value="9">Oktober</option>
                                        <option value="10">November</option>
                                        <option value="11">Dezember</option>
                                    </select>
                                </label>
                                <select id="kalenderWerkzeugFilter" onchange="loadBuchungskalender()">
                                    <option value="">Alle Werkzeuge</option>
                                </select>
                                <button class="btn-secondary btn-small" onclick="resetKalenderFilter()">Aktueller Monat</button>
                            </div>
                            
                            <div id="kalenderContainer" style="overflow-x: auto; margin-top: 20px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Warenkorb Button -->
    <div class="warenkorb" onclick="showWarenkorb()" id="warenkorbBtn" style="display: none;">
        üõí Warenkorb (<span id="warenkorbCount">0</span>)
    </div>
    
    <!-- Warenkorb Modal -->
    <div class="modal" id="warenkorbModal">
        <div class="modal-content">
            <h2>Warenkorb - Reservierung abschlie√üen</h2>
            <div class="form-group">
                <label>Ihr Name: *</label>
                <input type="text" id="mitarbeiterName" placeholder="Max Mustermann">
            </div>
            <div class="form-group">
                <label>Zeitraum:</label>
                <div class="date-inputs">
                    <div>
                        <label>Von: *</label>
                        <input type="date" id="datumVon">
                    </div>
                    <div>
                        <label>Bis: *</label>
                        <input type="date" id="datumBis">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Werkzeuge:</label>
                <div id="warenkorbItems"></div>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn-success" onclick="reservieren()">Reservieren</button>
                <button class="btn-secondary" onclick="closeModal('warenkorbModal')">Abbrechen</button>
            </div>
        </div>
    </div>
    
    <!-- Werkzeug hinzuf√ºgen/bearbeiten Modal -->
    <div class="modal" id="werkzeugModal">
        <div class="modal-content">
            <h2 id="werkzeugModalTitle">Werkzeug hinzuf√ºgen</h2>
            <div class="form-group">
                <label>Werkzeugname: *</label>
                <input type="text" id="werkzeugName">
            </div>
            <div class="form-group">
                <label>Icon (Emoji):</label>
                <input type="text" id="werkzeugIcon" placeholder="z.B. üî® üîß ‚ö° ü™õ" maxlength="2" style="font-size: 2em; text-align: center; width: 80px;">
                <small style="color: #999; display: block; margin-top: 5px;">Emoji-Picker des Ger√§ts nutzen oder kopieren/einf√ºgen</small>
            </div>
            <div class="form-group">
                <label>Kategorie: *</label>
                <select id="werkzeugKategorie">
                    <option value="">Bitte w√§hlen...</option>
                    <option value="Elektro">üîå Elektro</option>
                    <option value="Hand">üî® Hand</option>
                    <option value="Mess">üìê Mess</option>
                    <option value="Sicherheit">ü¶∫ Sicherheit</option>
                    <option value="Sonstiges">üì¶ Sonstiges</option>
                </select>
            </div>
            <div class="form-group">
                <label>Beschreibung:</label>
                <textarea id="werkzeugBeschreibung" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label>Inventarnummer: *</label>
                <input type="text" id="werkzeugInventarnummer">
            </div>
            <div class="form-group">
                <label>Lagerplatz:</label>
                <input type="text" id="werkzeugLagerplatz" placeholder="z.B. Halle A, Regal 3">
            </div>
            <div class="form-group">
                <label>Zustand:</label>
                <select id="werkzeugZustand">
                    <option value="Neu">Neu</option>
                    <option value="Gut">Gut</option>
                    <option value="Gebraucht">Gebraucht</option>
                    <option value="Reparaturbed√ºrftig">Reparaturbed√ºrftig</option>
                </select>
            </div>
            <div class="form-group">
                <label>Foto: <span style="font-size: 0.85em; color: #999;">(max. 2MB)</span></label>
                <label class="file-input-label" for="werkzeugFoto">Foto ausw√§hlen</label>
                <input type="file" id="werkzeugFoto" accept="image/*" onchange="previewFoto(event)">
                <div id="fotoPreview"></div>
            </div>
            <input type="hidden" id="werkzeugId">
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn-success" onclick="saveWerkzeug()">Speichern</button>
                <button class="btn-secondary" onclick="closeModal('werkzeugModal')">Abbrechen</button>
            </div>
        </div>
    </div>
    
    <!-- QR-Code Modal -->
    <div class="modal" id="qrModal">
        <div class="modal-content">
            <h2>QR-Code: <span id="qrWerkzeugName"></span></h2>
            <div class="qr-code-container">
                <div id="qrcode"></div>
                <p style="margin-top: 15px; font-size: 0.9em;">
                    <strong>Inventarnummer:</strong> <span id="qrInventarnummer"></span>
                </p>
                <p style="font-size: 0.85em; color: #9333ea; margin-top: 10px; font-weight: bold;">
                    üì± QR-Code mit Handy scannen!
                </p>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                    √ñffnet die App und legt das Werkzeug automatisch in den Warenkorb.
                </p>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                <button class="btn-primary" onclick="printQRCode()">üñ®Ô∏è Drucken</button>
                <button class="btn-secondary" onclick="closeModal('qrModal')">Schlie√üen</button>
            </div>
        </div>
    </div>
    
    <!-- Ad-hoc Zuordnung Modal (bei QR-Scan ohne Reservierung) -->
    <div class="modal" id="adhocModal">
        <div class="modal-content">
            <h2>üîß Werkzeug direkt ausgeben</h2>
            <p><strong>Werkzeug:</strong> <span id="adhocWerkzeugName"></span></p>
            <p><strong>Inventarnummer:</strong> <span id="adhocInventarnummer"></span></p>
            <div class="form-group" style="margin-top: 15px;">
                <label>Mitarbeiter: *</label>
                <input type="text" id="adhocMitarbeiter" placeholder="Name des Mitarbeiters">
            </div>
            <div class="form-group">
                <label>Zeitraum:</label>
                <div class="date-inputs">
                    <div>
                        <label>Von: *</label>
                        <input type="date" id="adhocVon">
                    </div>
                    <div>
                        <label>Bis: *</label>
                        <input type="date" id="adhocBis">
                    </div>
                </div>
            </div>
            <input type="hidden" id="adhocWerkzeugId">
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn-success" onclick="submitAdhocAusgabe()">‚úì Direkt ausgeben</button>
                <button class="btn-secondary" onclick="closeModal('adhocModal')">Abbrechen</button>
            </div>
        </div>
    </div>
    
    <!-- Schadensmeldung Modal -->
    <div class="modal" id="schadenModal">
        <div class="modal-content">
            <h2>Schaden melden</h2>
            <div class="form-group">
                <label>Ihr Name: *</label>
                <input type="text" id="schadenMitarbeiter" placeholder="Max Mustermann">
            </div>
            <div class="form-group">
                <label>Beschreibung des Schadens: *</label>
                <textarea id="schadenBeschreibung" rows="3" placeholder="Was ist defekt/besch√§digt?"></textarea>
            </div>
            <div class="form-group">
                <label>Foto (optional):</label>
                <label class="file-input-label" for="schadenFoto">Foto ausw√§hlen</label>
                <input type="file" id="schadenFoto" accept="image/*" onchange="previewSchadenFoto(event)">
                <div id="schadenFotoPreview"></div>
            </div>
            <input type="hidden" id="schadenWerkzeugId">
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn-danger" onclick="submitSchaden()">Schaden melden</button>
                <button class="btn-secondary" onclick="closeModal('schadenModal')">Abbrechen</button>
            </div>
        </div>
    </div>
    
    <!-- R√ºckgabe Modal -->
    <div class="modal" id="rueckgabeModal">
        <div class="modal-content">
            <h2>R√ºckgabe best√§tigen</h2>
            <div class="form-group">
                <label>Zustand bei R√ºckgabe:</label>
                <select id="rueckgabeZustand">
                    <option value="OK">OK</option>
                    <option value="Defekt">Defekt</option>
                    <option value="Reinigung n√∂tig">Reinigung n√∂tig</option>
                    <option value="Reparatur n√∂tig">Reparatur n√∂tig</option>
                </select>
            </div>
            <div class="form-group">
                <label>Kommentar:</label>
                <textarea id="rueckgabeKommentar" rows="2" placeholder="Optional"></textarea>
            </div>
            <input type="hidden" id="rueckgabeAusleiheId">
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn-success" onclick="confirmRueckgabe()">Best√§tigen</button>
                <button class="btn-secondary" onclick="closeModal('rueckgabeModal')">Abbrechen</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <h2>‚ö†Ô∏è Werkzeug l√∂schen</h2>
            <p>M√∂chtest du dieses Werkzeug wirklich l√∂schen?</p>
            <p id="deleteWerkzeugInfo" style="margin-top: 10px; font-weight: bold;"></p>
            <p style="margin-top: 10px; color: #f44336; font-size: 0.9em;">Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!</p>
            <input type="hidden" id="deleteWerkzeugId">
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn-danger" onclick="confirmDelete()">Ja, l√∂schen</button>
                <button class="btn-secondary" onclick="closeModal('deleteModal')">Abbrechen</button>
            </div>
        </div>
    </div>
    
    <!-- Buchung bearbeiten Modal -->
    <div class="modal" id="editBuchungModal">
        <div class="modal-content">
            <h2>Buchung bearbeiten</h2>
            <div class="form-group">
                <label>Werkzeug:</label>
                <p id="editBuchungWerkzeug" style="font-weight: bold; margin-top: 5px;"></p>
            </div>
            <div class="form-group">
                <label>Mitarbeiter: *</label>
                <input type="text" id="editBuchungMitarbeiter" placeholder="Name des Mitarbeiters">
            </div>
            <div class="form-group">
                <label>Zeitraum:</label>
                <div class="date-inputs">
                    <div>
                        <label>Von: *</label>
                        <input type="date" id="editBuchungVon">
                    </div>
                    <div>
                        <label>Bis: *</label>
                        <input type="date" id="editBuchungBis">
                    </div>
                </div>
            </div>
            <input type="hidden" id="editBuchungId">
            <input type="hidden" id="editBuchungWerkzeugId">
            <input type="hidden" id="editBuchungOriginalVon">
            <input type="hidden" id="editBuchungOriginalBis">
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn-success" onclick="saveBuchungEdit()">Speichern</button>
                <button class="btn-secondary" onclick="closeModal('editBuchungModal')">Abbrechen</button>
            </div>
        </div>
    </div>
    
    <!-- Buchung l√∂schen Modal -->
    <div class="modal" id="deleteBuchungModal">
        <div class="modal-content">
            <h2>‚ö†Ô∏è Buchung l√∂schen</h2>
            <p>M√∂chtest du diese Buchung wirklich l√∂schen?</p>
            <p id="deleteBuchungInfo" style="margin-top: 10px; font-weight: bold;"></p>
            <p style="margin-top: 10px; color: #ff9800; font-size: 0.9em;">Der Werkzeugstatus wird auf "verf√ºgbar" zur√ºckgesetzt.</p>
            <input type="hidden" id="deleteBuchungId">
            <input type="hidden" id="deleteBuchungWerkzeugId">
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn-danger" onclick="confirmBuchungDelete()">Ja, l√∂schen</button>
                <button class="btn-secondary" onclick="closeModal('deleteBuchungModal')">Abbrechen</button>
            </div>
        </div>
    </div>
    
    <script>
        // Globale Variablen
        let db = null;
        let warenkorb = new Set();
        let currentMode = 'mitarbeiter';
        let isAdminLoggedIn = false;
        const ADMIN_PASSWORD = 'admin123';
        const MAX_PHOTO_SIZE = 2 * 1024 * 1024;
        let allAusleihenData = [];
        
        // SQL.js initialisieren
        initSqlJs({
            locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
        }).then(function(SQL) {
            initDatabase(SQL);
        }).catch(function(err) {
            showError('SQL.js konnte nicht geladen werden. Bitte √ºberpr√ºfe deine Internetverbindung.');
            console.error(err);
        });
        
        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }
        
        function initDatabase(SQL) {
            try {
                const savedAdminState = sessionStorage.getItem('adminLoggedIn');
                if (savedAdminState === 'true') {
                    isAdminLoggedIn = true;
                }

                const savedDb = localStorage.getItem('werkzeugDB');
                if (savedDb) {
                    const binary = atob(savedDb);
                    const bytes = new Uint8Array(binary.length);
                    for (let i = 0; i < binary.length; i++) {
                        bytes[i] = binary.charCodeAt(i);
                    }
                    db = new SQL.Database(bytes);
                    
                    migrateDatabase();
                } else {
                    db = new SQL.Database();
                    createTables();
                    saveDatabase();
                }
                
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                document.getElementById('warenkorbBtn').style.display = 'block';
                
                loadKategorien();
                loadWerkzeuge();
                loadMeineReservierungen();
                
                // QR-Code Scan: Pr√ºfe URL-Parameter
                checkQRCodeScan();
            } catch (err) {
                showError('Fehler beim Initialisieren: ' + err.message);
                console.error(err);
            }
        }
        
        // QR-Code Scan Handler
        function checkQRCodeScan() {
            const urlParams = new URLSearchParams(window.location.search);
            const inventarnummer = urlParams.get('inv');
            const isAdminScan = urlParams.get('admin') === '1';
            
            if (inventarnummer) {
                // Werkzeug anhand Inventarnummer finden
                const stmt = db.prepare("SELECT * FROM werkzeuge WHERE inventarnummer = ?");
                stmt.bind([inventarnummer]);
                
                if (stmt.step()) {
                    const werkzeug = stmt.getAsObject();
                    stmt.free();
                    
                    if (isAdminScan) {
                        // Admin-Scan: Automatische Ausgabe oder Ad-hoc
                        handleAdminScan(werkzeug);
                    } else {
                        // Normaler Mitarbeiter-Scan: Zum Warenkorb (nur wenn verf√ºgbar)
                        if (werkzeug.status === 'verfuegbar') {
                            warenkorb.add(werkzeug.id);
                            updateWarenkorbCount();
                            loadWerkzeuge();
                            showToast(`‚úì ${werkzeug.name} (${inventarnummer}) automatisch zum Warenkorb hinzugef√ºgt!`);
                        } else {
                            alert(`‚ùå Werkzeug "${werkzeug.name}" ist aktuell nicht verf√ºgbar (Status: ${werkzeug.status}).`);
                        }
                    }
                    
                    // URL bereinigen
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else {
                    stmt.free();
                    alert(`‚ùå Werkzeug mit Inventarnummer "${inventarnummer}" nicht gefunden.`);
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }
        
        function handleAdminScan(werkzeug) {
            if (werkzeug.status === 'reserviert') {
                // Automatisch ausgeben: reserviert ‚Üí ausgeliehen
                const stmt = db.prepare('SELECT * FROM ausleihen WHERE werkzeug_id = ? AND status = ?');
                stmt.bind([werkzeug.id, 'reserviert']);
                
                if (stmt.step()) {
                    const ausleihe = stmt.getAsObject();
                    stmt.free();
                    
                    const now = new Date().toISOString();
                    db.run("UPDATE ausleihen SET status = 'ausgeliehen', ausgeliehen_am = ? WHERE id = ?", [now, ausleihe.id]);
                    db.run("UPDATE werkzeuge SET status = 'ausgeliehen' WHERE id = ?", [werkzeug.id]);
                    
                    if (saveDatabase()) {
                        showToast(`‚úì ${werkzeug.name} automatisch ausgegeben an ${ausleihe.mitarbeiter_name}!`);
                        loadWerkzeuge();
                        loadMeineReservierungen();
                    }
                } else {
                    stmt.free();
                    alert('‚ùå Keine Reservierung f√ºr dieses Werkzeug gefunden.');
                }
            } else if (werkzeug.status === 'verfuegbar') {
                // Ad-hoc Zuordnung: Modal √∂ffnen
                showAdhocModal(werkzeug);
            } else if (werkzeug.status === 'ausgeliehen') {
                alert(`‚ùå Werkzeug "${werkzeug.name}" ist bereits ausgeliehen.`);
            } else if (werkzeug.status === 'defekt') {
                alert(`‚ùå Werkzeug "${werkzeug.name}" ist defekt und kann nicht ausgegeben werden.`);
            }
        }
        
        function showAdhocModal(werkzeug) {
            document.getElementById('adhocWerkzeugName').textContent = werkzeug.name;
            document.getElementById('adhocInventarnummer').textContent = werkzeug.inventarnummer;
            document.getElementById('adhocWerkzeugId').value = werkzeug.id;
            document.getElementById('adhocMitarbeiter').value = '';
            
            // Heute + 7 Tage
            const heute = new Date();
            const inEinerWoche = new Date();
            inEinerWoche.setDate(heute.getDate() + 7);
            
            document.getElementById('adhocVon').value = heute.toISOString().split('T')[0];
            document.getElementById('adhocBis').value = inEinerWoche.toISOString().split('T')[0];
            
            document.getElementById('adhocModal').classList.add('active');
        }
        
        function submitAdhocAusgabe() {
            const werkzeugId = document.getElementById('adhocWerkzeugId').value;
            const mitarbeiter = document.getElementById('adhocMitarbeiter').value.trim();
            const von = document.getElementById('adhocVon').value;
            const bis = document.getElementById('adhocBis').value;
            
            if (!mitarbeiter || !von || !bis) {
                alert('‚ùå Bitte alle Felder ausf√ºllen!');
                return;
            }
            
            if (new Date(bis) < new Date(von)) {
                alert('‚ùå "Bis"-Datum muss nach "Von"-Datum liegen!');
                return;
            }
            
            const now = new Date().toISOString();
            
            try {
                // Direkt als "ausgeliehen" anlegen (nicht reserviert)
                db.run('INSERT INTO ausleihen (werkzeug_id, mitarbeiter_name, datum_von, datum_bis, reserviert_am, ausgeliehen_am, status) VALUES (?, ?, ?, ?, ?, ?, ?)',
                    [werkzeugId, mitarbeiter, von, bis, now, now, 'ausgeliehen']);
                db.run("UPDATE werkzeuge SET status = 'ausgeliehen' WHERE id = ?", [werkzeugId]);
                
                if (saveDatabase()) {
                    closeModal('adhocModal');
                    loadWerkzeuge();
                    loadMeineReservierungen();
                    showToast(`‚úì Werkzeug direkt an ${mitarbeiter} ausgegeben!`);
                }
            } catch (err) {
                alert('Fehler beim Ausgeben: ' + err.message);
                console.error(err);
            }
        }
        
        function createTables() {
            db.run(`
                CREATE TABLE werkzeuge (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    name TEXT NOT NULL,
                    icon TEXT,
                    beschreibung TEXT,
                    inventarnummer TEXT UNIQUE NOT NULL,
                    zustand TEXT,
                    foto TEXT,
                    status TEXT DEFAULT 'verfuegbar',
                    kategorie TEXT,
                    lagerplatz TEXT
                );
                
                CREATE TABLE ausleihen (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    werkzeug_id INTEGER NOT NULL,
                    mitarbeiter_name TEXT,
                    datum_von TEXT,
                    datum_bis TEXT,
                    reserviert_am TEXT,
                    ausgeliehen_am TEXT,
                    zurueckgegeben_am TEXT,
                    status TEXT DEFAULT 'reserviert',
                    rueckgabe_zustand TEXT,
                    rueckgabe_kommentar TEXT,
                    FOREIGN KEY (werkzeug_id) REFERENCES werkzeuge(id)
                );
                
                CREATE TABLE schaeden (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    werkzeug_id INTEGER NOT NULL,
                    mitarbeiter_name TEXT,
                    beschreibung TEXT,
                    foto TEXT,
                    gemeldet_am TEXT,
                    status TEXT DEFAULT 'offen',
                    FOREIGN KEY (werkzeug_id) REFERENCES werkzeuge(id)
                );
            `);
        }
        
        function migrateDatabase() {
            try {
                // Kategorie-Spalte hinzuf√ºgen
                db.run(`ALTER TABLE werkzeuge ADD COLUMN kategorie TEXT`);
            } catch (e) {
                // Spalte existiert bereits
            }
            
            try {
                // Lagerplatz-Spalte hinzuf√ºgen
                db.run(`ALTER TABLE werkzeuge ADD COLUMN lagerplatz TEXT`);
            } catch (e) {
                // Spalte existiert bereits
            }
            
            try {
                // Icon-Spalte hinzuf√ºgen
                db.run(`ALTER TABLE werkzeuge ADD COLUMN icon TEXT`);
            } catch (e) {
                // Spalte existiert bereits
            }
            
            try {
                // Status-Spalte hinzuf√ºgen (falls alte DB)
                db.run(`ALTER TABLE werkzeuge ADD COLUMN status TEXT DEFAULT 'verfuegbar'`);
                db.run(`UPDATE werkzeuge SET status = CASE WHEN verfuegbar = 1 THEN 'verfuegbar' ELSE 'ausgeliehen' END`);
            } catch (e) {
                // Spalte existiert bereits
            }
            
            try {
                // Schaeden-Tabelle erstellen
                db.run(`
                    CREATE TABLE IF NOT EXISTS schaeden (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        werkzeug_id INTEGER NOT NULL,
                        mitarbeiter_name TEXT,
                        beschreibung TEXT,
                        foto TEXT,
                        gemeldet_am TEXT,
                        status TEXT DEFAULT 'offen',
                        FOREIGN KEY (werkzeug_id) REFERENCES werkzeuge(id)
                    );
                `);
            } catch (e) {}
            
            try {
                // Pr√ºfe ob mitarbeiter_name existiert
                const stmt = db.prepare('SELECT mitarbeiter_name FROM ausleihen LIMIT 1');
                stmt.free();
            } catch (e) {
                // Alte ausleihen Tabelle migrieren
                db.run(`
                    CREATE TABLE IF NOT EXISTS ausleihen_new (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        werkzeug_id INTEGER NOT NULL,
                        mitarbeiter_name TEXT,
                        datum_von TEXT,
                        datum_bis TEXT,
                        reserviert_am TEXT,
                        ausgeliehen_am TEXT,
                        zurueckgegeben_am TEXT,
                        status TEXT DEFAULT 'reserviert',
                        rueckgabe_zustand TEXT,
                        rueckgabe_kommentar TEXT,
                        FOREIGN KEY (werkzeug_id) REFERENCES werkzeuge(id)
                    );
                    
                    INSERT INTO ausleihen_new (werkzeug_id, ausgeliehen_am, zurueckgegeben_am, status, rueckgabe_zustand, rueckgabe_kommentar)
                    SELECT werkzeug_id, ausgeliehen_am, zurueckgegeben_am, 
                           CASE WHEN zurueckgegeben_am IS NULL THEN 'ausgeliehen' ELSE 'zurueckgegeben' END,
                           status, kommentar 
                    FROM ausleihen;
                    
                    DROP TABLE ausleihen;
                    ALTER TABLE ausleihen_new RENAME TO ausleihen;
                `);
            }
            
            // Cleanup: Alte "behoben" Schadensmeldungen l√∂schen (Issue #12)
            try {
                db.run(`DELETE FROM schaeden WHERE status = 'behoben'`);
            } catch (e) {
                // Tabelle existiert m√∂glicherweise noch nicht
            }
            
            saveDatabase();
        }
        
        function saveDatabase() {
            try {
                const data = db.export();
                
                let binary = '';
                const chunkSize = 8192;
                for (let i = 0; i < data.length; i += chunkSize) {
                    const chunk = data.subarray(i, Math.min(i + chunkSize, data.length));
                    binary += String.fromCharCode.apply(null, Array.from(chunk));
                }
                
                const base64 = btoa(binary);
                localStorage.setItem('werkzeugDB', base64);
                return true;
            } catch (err) {
                if (err.name === 'QuotaExceededError') {
                    alert('‚ö†Ô∏è Speicher voll! Datenbank konnte nicht gespeichert werden.');
                } else {
                    alert('Fehler beim Speichern: ' + err.message);
                }
                console.error(err);
                return false;
            }
        }
        
        function loadKategorien() {
            const stmt = db.prepare('SELECT DISTINCT kategorie FROM werkzeuge WHERE kategorie IS NOT NULL ORDER BY kategorie');
            const select = document.getElementById('kategorieFilter');
            
            // Alte Optionen entfernen (au√üer "Alle Kategorien")
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            while (stmt.step()) {
                const kat = stmt.getAsObject().kategorie;
                const option = document.createElement('option');
                option.value = kat;
                option.textContent = kat;
                select.appendChild(option);
            }
            stmt.free();
        }
        
        function loadDashboard() {
            const statsStmt = db.prepare(`
                SELECT 
                    COUNT(*) as gesamt,
                    SUM(CASE WHEN status = 'verfuegbar' THEN 1 ELSE 0 END) as verfuegbar,
                    SUM(CASE WHEN status = 'reserviert' THEN 1 ELSE 0 END) as reserviert,
                    SUM(CASE WHEN status = 'ausgeliehen' THEN 1 ELSE 0 END) as ausgeliehen,
                    SUM(CASE WHEN status = 'defekt' THEN 1 ELSE 0 END) as defekt
                FROM werkzeuge
            `);
            
            let stats = {};
            if (statsStmt.step()) {
                stats = statsStmt.getAsObject();
            }
            statsStmt.free();
            
            // √úberf√§llige Ausleihen
            const overdueStmt = db.prepare(`
                SELECT COUNT(*) as count 
                FROM ausleihen 
                WHERE status IN ('reserviert', 'ausgeliehen') 
                AND datum_bis < date('now')
            `);
            let overdueCount = 0;
            if (overdueStmt.step()) {
                overdueCount = overdueStmt.getAsObject().count;
            }
            overdueStmt.free();
            
            // Offene Sch√§den
            const schadenStmt = db.prepare(`SELECT COUNT(*) as count FROM schaeden WHERE status = 'offen'`);
            let schadenCount = 0;
            if (schadenStmt.step()) {
                schadenCount = schadenStmt.getAsObject().count;
            }
            schadenStmt.free();
            
            // Dashboard rendern
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = `
                <div class="dashboard-card">
                    <h3>${stats.gesamt}</h3>
                    <p>Werkzeuge gesamt</p>
                </div>
                <div class="dashboard-card">
                    <h3>${stats.verfuegbar}</h3>
                    <p>Verf√ºgbar</p>
                </div>
                <div class="dashboard-card">
                    <h3>${stats.reserviert}</h3>
                    <p>Reserviert</p>
                </div>
                <div class="dashboard-card">
                    <h3>${stats.ausgeliehen}</h3>
                    <p>Ausgeliehen</p>
                </div>
                ${overdueCount > 0 ? `
                <div class="dashboard-card alert">
                    <h3>${overdueCount}</h3>
                    <p>‚ö†Ô∏è √úberf√§llig</p>
                </div>
                ` : ''}
                ${schadenCount > 0 ? `
                <div class="dashboard-card alert">
                    <h3>${schadenCount}</h3>
                    <p>üîß Offene Sch√§den</p>
                </div>
                ` : ''}
            `;
        }
        
        function isOverdue(datumBis) {
            if (!datumBis) return false;
            const bis = new Date(datumBis);
            const heute = new Date();
            heute.setHours(0, 0, 0, 0);
            bis.setHours(0, 0, 0, 0);
            return bis < heute;
        }
        
        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('mitarbeiterMode').classList.toggle('hidden', mode !== 'mitarbeiter');
            document.getElementById('adminMode').classList.toggle('hidden', mode !== 'admin');
            
            document.getElementById('mitarbeiterBtn').className = mode === 'mitarbeiter' ? 'btn-primary' : 'btn-secondary';
            document.getElementById('adminBtn').className = mode === 'admin' ? 'btn-primary' : 'btn-secondary';
            
            if (mode === 'mitarbeiter') {
                loadWerkzeuge();
                loadMeineReservierungen();
            } else {
                if (isAdminLoggedIn) {
                    document.getElementById('adminLogin').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    loadDashboard();
                    loadAdminWerkzeuge();
                    loadAlleAusleihen();
                    loadSchadensberichte();
                } else {
                    document.getElementById('adminLogin').classList.remove('hidden');
                    document.getElementById('adminPanel').classList.add('hidden');
                }
            }
        }
        
        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                sessionStorage.setItem('adminLoggedIn', 'true');
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                loadDashboard();
                loadAdminWerkzeuge();
                loadAlleAusleihen();
                loadSchadensberichte();
            } else {
                alert('‚ùå Falsches Passwort!');
            }
        }
        
        function checkWerkzeugAvailability(werkzeugId, vonDate, bisDate) {
            // Pr√ºfe ob Werkzeug im Zeitraum verf√ºgbar ist (keine √úberschneidung mit Reservierungen/Ausleihen)
            const stmt = db.prepare(`
                SELECT COUNT(*) as count FROM ausleihen 
                WHERE werkzeug_id = ? 
                AND status IN ('reserviert', 'ausgeliehen')
                AND (
                    (datum_von <= ? AND datum_bis >= ?) OR
                    (datum_von >= ? AND datum_von <= ?) OR
                    (datum_bis >= ? AND datum_bis <= ?)
                )
            `);
            stmt.bind([werkzeugId, bisDate, vonDate, vonDate, bisDate, vonDate, bisDate]);
            
            let conflicts = 0;
            if (stmt.step()) {
                conflicts = stmt.getAsObject().count;
            }
            stmt.free();
            
            return conflicts === 0;
        }
        
        function loadWerkzeuge() {
            const von = document.getElementById('mitarbeiterVon').value;
            const bis = document.getElementById('mitarbeiterBis').value;
            const hasDateFilter = von && bis;
            
            // Validierung
            if (hasDateFilter && new Date(bis) < new Date(von)) {
                const tbody = document.getElementById('werkzeugBody');
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 30px; color: #f44336;">‚ùå "Bis"-Datum muss nach "Von"-Datum liegen!</td></tr>';
                document.getElementById('werkzeugTable').style.display = 'table';
                document.getElementById('emptyWerkzeuge').classList.add('hidden');
                return;
            }
            
            const stmt = db.prepare("SELECT * FROM werkzeuge ORDER BY name");
            const alleWerkzeuge = [];
            while (stmt.step()) {
                alleWerkzeuge.push(stmt.getAsObject());
            }
            stmt.free();
            
            // Filtern nach Verf√ºgbarkeit
            let werkzeuge;
            if (hasDateFilter) {
                // Nur Werkzeuge anzeigen, die im Zeitraum vollst√§ndig verf√ºgbar sind
                werkzeuge = alleWerkzeuge.filter(w => {
                    if (w.status === 'defekt') return false;
                    // Auch aktuell reservierte/ausgeliehene k√∂nnen sp√§ter verf√ºgbar sein
                    return checkWerkzeugAvailability(w.id, von, bis);
                });
            } else {
                // Standard: nur aktuell verf√ºgbare oder defekte anzeigen
                werkzeuge = alleWerkzeuge.filter(w => w.status === 'verfuegbar' || w.status === 'defekt');
            }
            
            const verfuegbareIds = new Set(werkzeuge.filter(w => w.status === 'verfuegbar' || (hasDateFilter && w.status !== 'defekt')).map(w => w.id));
            warenkorb.forEach(id => {
                if (!verfuegbareIds.has(id)) warenkorb.delete(id);
            });
            updateWarenkorbCount();
            
            const tbody = document.getElementById('werkzeugBody');
            tbody.innerHTML = '';
            
            if (werkzeuge.length === 0) {
                document.getElementById('werkzeugTable').style.display = 'table';
                document.getElementById('emptyWerkzeuge').classList.add('hidden');
                if (hasDateFilter) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 30px; color: #999;">üìÖ Keine Werkzeuge im gew√§hlten Zeitraum verf√ºgbar</td></tr>';
                } else {
                    document.getElementById('werkzeugTable').style.display = 'none';
                    document.getElementById('emptyWerkzeuge').classList.remove('hidden');
                }
            } else {
                document.getElementById('werkzeugTable').style.display = 'table';
                document.getElementById('emptyWerkzeuge').classList.add('hidden');
                
                werkzeuge.forEach(w => {
                    const tr = document.createElement('tr');
                    const foto = w.foto ? `<img src="${w.foto}" class="werkzeug-foto">` : 'üîß';
                    const inWarenkorb = warenkorb.has(w.id);
                    const isDefekt = w.status === 'defekt';
                    const kategorieBadge = w.kategorie ? `<span class="kategorie-badge">${w.kategorie}</span>` : '';
                    
                    let statusBadge = '';
                    if (isDefekt) {
                        statusBadge = '<span class="badge badge-defekt">Defekt</span>';
                    } else if (hasDateFilter) {
                        statusBadge = '<span class="badge badge-available">‚úì Verf√ºgbar im Zeitraum</span>';
                    } else if (w.status === 'verfuegbar') {
                        statusBadge = '<span class="badge badge-available">Verf√ºgbar</span>';
                    }
                    
                    tr.innerHTML = `
                        <td>${foto}</td>
                        <td><strong>${w.name}</strong></td>
                        <td>${kategorieBadge}</td>
                        <td>${w.inventarnummer}</td>
                        <td>${w.beschreibung || '-'}</td>
                        <td>${w.zustand}</td>
                        <td>${statusBadge}</td>
                        <td>
                            ${isDefekt ? 
                                `<button class="btn-warning btn-small" onclick="showSchadenModal(${w.id})">üîß Schaden melden</button>` :
                                `<button class="btn-primary btn-small" onclick="addToWarenkorb(${w.id}, '${escapeQuotes(w.name)}')">
                                    ${inWarenkorb ? '‚úì Im Warenkorb' : '+ Zum Warenkorb'}
                                </button>`
                            }
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }
        
        function filterWerkzeuge() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const kategorie = document.getElementById('kategorieFilter').value;
            const von = document.getElementById('mitarbeiterVon').value;
            const bis = document.getElementById('mitarbeiterBis').value;
            const hasDateFilter = von && bis;
            
            // Validierung
            if (hasDateFilter && new Date(bis) < new Date(von)) {
                const tbody = document.getElementById('werkzeugBody');
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 30px; color: #f44336;">‚ùå "Bis"-Datum muss nach "Von"-Datum liegen!</td></tr>';
                return;
            }
            
            let query = "SELECT * FROM werkzeuge WHERE 1=1";
            const params = [];
            
            if (search) {
                query += " AND (LOWER(name) LIKE ? OR LOWER(inventarnummer) LIKE ?)";
                params.push(`%${search}%`, `%${search}%`);
            }
            
            if (kategorie) {
                query += " AND kategorie = ?";
                params.push(kategorie);
            }
            
            query += " ORDER BY name";
            
            const stmt = db.prepare(query);
            stmt.bind(params);
            
            const alleWerkzeuge = [];
            while (stmt.step()) {
                alleWerkzeuge.push(stmt.getAsObject());
            }
            stmt.free();
            
            // Filtern nach Verf√ºgbarkeit im Zeitraum
            let werkzeuge;
            if (hasDateFilter) {
                werkzeuge = alleWerkzeuge.filter(w => {
                    if (w.status === 'defekt') return false;
                    return checkWerkzeugAvailability(w.id, von, bis);
                });
            } else {
                werkzeuge = alleWerkzeuge.filter(w => w.status === 'verfuegbar' || w.status === 'defekt');
            }
            
            const tbody = document.getElementById('werkzeugBody');
            tbody.innerHTML = '';
            
            if (werkzeuge.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 30px; color: #999;">Keine Werkzeuge gefunden</td></tr>';
            } else {
                werkzeuge.forEach(w => {
                    const tr = document.createElement('tr');
                    const foto = w.foto ? `<img src="${w.foto}" class="werkzeug-foto">` : 'üîß';
                    const inWarenkorb = warenkorb.has(w.id);
                    const isDefekt = w.status === 'defekt';
                    const kategorieBadge = w.kategorie ? `<span class="kategorie-badge">${w.kategorie}</span>` : '';
                    
                    let statusBadge = '';
                    if (isDefekt) {
                        statusBadge = '<span class="badge badge-defekt">Defekt</span>';
                    } else if (hasDateFilter) {
                        statusBadge = '<span class="badge badge-available">‚úì Verf√ºgbar im Zeitraum</span>';
                    } else if (w.status === 'verfuegbar') {
                        statusBadge = '<span class="badge badge-available">Verf√ºgbar</span>';
                    }
                    
                    tr.innerHTML = `
                        <td>${foto}</td>
                        <td><strong>${w.name}</strong></td>
                        <td>${kategorieBadge}</td>
                        <td>${w.inventarnummer}</td>
                        <td>${w.beschreibung || '-'}</td>
                        <td>${w.zustand}</td>
                        <td>${statusBadge}</td>
                        <td>
                            ${isDefekt ? 
                                `<button class="btn-warning btn-small" onclick="showSchadenModal(${w.id})">üîß Schaden melden</button>` :
                                `<button class="btn-primary btn-small" onclick="addToWarenkorb(${w.id}, '${escapeQuotes(w.name)}')">
                                    ${inWarenkorb ? '‚úì Im Warenkorb' : '+ Zum Warenkorb'}
                                </button>`
                            }
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }
        
        function filterWerkzeugeByAvailability() {
            loadWerkzeuge();
        }
        
        function clearMitarbeiterDateFilter() {
            document.getElementById('mitarbeiterVon').value = '';
            document.getElementById('mitarbeiterBis').value = '';
            loadWerkzeuge();
        }
        
        function escapeQuotes(str) {
            return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }
        
        function addToWarenkorb(id, name) {
            if (warenkorb.has(id)) {
                warenkorb.delete(id);
            } else {
                warenkorb.add(id);
                showToast(`‚úì ${name} zum Warenkorb hinzugef√ºgt`);
            }
            updateWarenkorbCount();
            loadWerkzeuge();
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'success-toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        function updateWarenkorbCount() {
            document.getElementById('warenkorbCount').textContent = warenkorb.size;
        }
        
        function showWarenkorb() {
            if (warenkorb.size === 0) {
                alert('üõí Warenkorb ist leer!');
                return;
            }
            
            // Pr√ºfe ob Datumsfilter gesetzt ist
            const filterVon = document.getElementById('mitarbeiterVon').value;
            const filterBis = document.getElementById('mitarbeiterBis').value;
            
            if (filterVon && filterBis) {
                // √úbernehme Datumsbereich aus Filter
                document.getElementById('datumVon').value = filterVon;
                document.getElementById('datumBis').value = filterBis;
            } else {
                // Standard: Heute + 7 Tage
                const heute = new Date();
                const inEinerWoche = new Date();
                inEinerWoche.setDate(heute.getDate() + 7);
                
                document.getElementById('datumVon').value = heute.toISOString().split('T')[0];
                document.getElementById('datumBis').value = inEinerWoche.toISOString().split('T')[0];
            }
            
            document.getElementById('mitarbeiterName').value = '';
            
            const container = document.getElementById('warenkorbItems');
            container.innerHTML = '';
            
            warenkorb.forEach(id => {
                const stmt = db.prepare('SELECT * FROM werkzeuge WHERE id = ?');
                stmt.bind([id]);
                if (stmt.step()) {
                    const w = stmt.getAsObject();
                    const item = document.createElement('div');
                    item.style.padding = '8px';
                    item.style.borderBottom = '1px solid #eee';
                    item.innerHTML = `<strong>${w.name}</strong> (${w.inventarnummer})`;
                    container.appendChild(item);
                }
                stmt.free();
            });
            
            document.getElementById('warenkorbModal').classList.add('active');
        }
        
        function reservieren() {
            const name = document.getElementById('mitarbeiterName').value.trim();
            const von = document.getElementById('datumVon').value;
            const bis = document.getElementById('datumBis').value;
            
            if (!name || !von || !bis) {
                alert('‚ùå Bitte Name und Zeitraum angeben!');
                return;
            }
            
            if (new Date(bis) < new Date(von)) {
                alert('‚ùå "Bis"-Datum muss nach "Von"-Datum liegen!');
                return;
            }
            
            const now = new Date().toISOString();
            
            try {
                warenkorb.forEach(id => {
                    db.run('INSERT INTO ausleihen (werkzeug_id, mitarbeiter_name, datum_von, datum_bis, reserviert_am, status) VALUES (?, ?, ?, ?, ?, ?)',
                        [id, name, von, bis, now, 'reserviert']);
                    db.run("UPDATE werkzeuge SET status = 'reserviert' WHERE id = ?", [id]);
                });
                
                if (saveDatabase()) {
                    warenkorb.clear();
                    updateWarenkorbCount();
                    closeModal('warenkorbModal');
                    loadWerkzeuge();
                    loadMeineReservierungen();
                    showToast('‚úì Reservierung erfolgreich!');
                }
            } catch (err) {
                alert('Fehler beim Reservieren: ' + err.message);
                console.error(err);
            }
        }
        
        function loadMeineReservierungen() {
            const stmt = db.prepare(`
                SELECT a.*, w.name, w.inventarnummer 
                FROM ausleihen a 
                JOIN werkzeuge w ON a.werkzeug_id = w.id 
                WHERE a.status IN ('reserviert', 'ausgeliehen')
                ORDER BY w.name ASC, a.datum_von ASC
            `);
            
            const tbody = document.getElementById('meineReservierungen');
            tbody.innerHTML = '';
            
            while (stmt.step()) {
                const a = stmt.getAsObject();
                const tr = document.createElement('tr');
                const overdue = isOverdue(a.datum_bis);
                
                if (overdue) tr.classList.add('overdue');
                
                let statusBadge = a.status === 'reserviert' ? 
                    '<span class="badge badge-reserved">Reserviert</span>' :
                    '<span class="badge badge-ausgeliehen">Ausgeliehen</span>';
                
                if (overdue) {
                    statusBadge += ' <span class="badge badge-overdue">‚ö†Ô∏è √úberf√§llig</span>';
                }
                
                tr.innerHTML = `
                    <td><strong>${a.name}</strong></td>
                    <td>${a.inventarnummer}</td>
                    <td>${a.mitarbeiter_name || '-'}</td>
                    <td>${formatDate(a.datum_von)}</td>
                    <td>${formatDate(a.datum_bis)}</td>
                    <td>${statusBadge}</td>
                    <td>${new Date(a.reserviert_am).toLocaleString('de-DE')}</td>
                    <td>${a.status === 'ausgeliehen' ? `<button class="btn-warning btn-small" onclick="showSchadenModal(${a.werkzeug_id})">üîß Schaden melden</button>` : '-'}</td>
                `;
                tbody.appendChild(tr);
            }
            stmt.free();
            
            if (tbody.children.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px; color: #999;">Keine aktiven Reservierungen</td></tr>';
            }
        }
        
        function loadAdminWerkzeuge() {
            const stmt = db.prepare('SELECT * FROM werkzeuge');
            const werkzeuge = [];
            while (stmt.step()) {
                werkzeuge.push(stmt.getAsObject());
            }
            stmt.free();
            
            const tbody = document.getElementById('adminWerkzeugBody');
            tbody.innerHTML = '';
            
            if (werkzeuge.length === 0) {
                document.getElementById('emptyAdminWerkzeuge').classList.remove('hidden');
                return;
            }
            
            document.getElementById('emptyAdminWerkzeuge').classList.add('hidden');
            
            werkzeuge.forEach(w => {
                const tr = document.createElement('tr');
                const foto = w.foto ? `<img src="${w.foto}" class="werkzeug-foto">` : 'üîß';
                const kategorieBadge = w.kategorie ? `<span class="kategorie-badge">${w.kategorie}</span>` : '';
                
                let statusBadge;
                if (w.status === 'verfuegbar') statusBadge = '<span class="badge badge-available">Verf√ºgbar</span>';
                else if (w.status === 'reserviert') statusBadge = '<span class="badge badge-reserved">Reserviert</span>';
                else if (w.status === 'defekt') statusBadge = '<span class="badge badge-defekt">Defekt</span>';
                else statusBadge = '<span class="badge badge-ausgeliehen">Ausgeliehen</span>';
                
                tr.innerHTML = `
                    <td>${foto}</td>
                    <td><strong>${w.name}</strong></td>
                    <td>${kategorieBadge}</td>
                    <td>${w.inventarnummer}</td>
                    <td>${w.lagerplatz || '-'}</td>
                    <td>${w.beschreibung || '-'}</td>
                    <td>${w.zustand}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn-secondary btn-small" onclick="editWerkzeug(${w.id})">‚úèÔ∏è</button>
                        <button class="btn-primary btn-small" onclick="showQRCode(${w.id}, '${escapeQuotes(w.name)}', '${w.inventarnummer}')">üì±</button>
                        <button class="btn-danger btn-small" onclick="showDeleteModal(${w.id}, '${escapeQuotes(w.name)}', '${w.inventarnummer}')">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function showQRCode(id, name, inventarnummer) {
            document.getElementById('qrWerkzeugName').textContent = name;
            document.getElementById('qrInventarnummer').textContent = inventarnummer;
            
            const qrcodeContainer = document.getElementById('qrcode');
            qrcodeContainer.innerHTML = '';
            
            // QR-Code mit vollst√§ndiger App-URL + Inventarnummer + Admin-Flag
            const appUrl = window.location.origin + window.location.pathname + '?inv=' + encodeURIComponent(inventarnummer) + '&admin=1';
            
            new QRCode(qrcodeContainer, {
                text: appUrl,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            document.getElementById('qrModal').classList.add('active');
        }
        
        function printQRCode() {
            window.print();
        }
        
        function showSchadenModal(werkzeugId) {
            document.getElementById('schadenWerkzeugId').value = werkzeugId;
            document.getElementById('schadenMitarbeiter').value = '';
            document.getElementById('schadenBeschreibung').value = '';
            document.getElementById('schadenFoto').value = '';
            document.getElementById('schadenFotoPreview').innerHTML = '';
            document.getElementById('schadenModal').classList.add('active');
        }
        
        function previewSchadenFoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    const maxWidth = 800;
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const compressed = canvas.toDataURL('image/jpeg', 0.8);
                    
                    const previewDiv = document.getElementById('schadenFotoPreview');
                    previewDiv.innerHTML = `<img src="${compressed}" style="max-width: 200px; border-radius: 5px; margin-top: 10px;">`;
                    previewDiv.dataset.compressed = compressed;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function submitSchaden() {
            const werkzeugId = document.getElementById('schadenWerkzeugId').value;
            const mitarbeiter = document.getElementById('schadenMitarbeiter').value.trim();
            const beschreibung = document.getElementById('schadenBeschreibung').value.trim();
            const previewDiv = document.getElementById('schadenFotoPreview');
            const foto = previewDiv.dataset.compressed || null;
            
            if (!mitarbeiter || !beschreibung) {
                alert('‚ùå Bitte Name und Beschreibung angeben!');
                return;
            }
            
            const now = new Date().toISOString();
            
            try {
                db.run('INSERT INTO schaeden (werkzeug_id, mitarbeiter_name, beschreibung, foto, gemeldet_am, status) VALUES (?, ?, ?, ?, ?, ?)',
                    [werkzeugId, mitarbeiter, beschreibung, foto, now, 'offen']);
                db.run("UPDATE werkzeuge SET status = 'defekt' WHERE id = ?", [werkzeugId]);
                
                if (saveDatabase()) {
                    closeModal('schadenModal');
                    loadWerkzeuge();
                    loadMeineReservierungen();
                    if (isAdminLoggedIn) {
                        loadDashboard();
                        loadAdminWerkzeuge();
                        loadSchadensberichte();
                    }
                    showToast('‚úì Schaden gemeldet!');
                }
            } catch (err) {
                alert('Fehler beim Melden: ' + err.message);
                console.error(err);
            }
        }
        
        function loadSchadensberichte() {
            const stmt = db.prepare(`
                SELECT s.*, w.name, w.inventarnummer
                FROM schaeden s
                JOIN werkzeuge w ON s.werkzeug_id = w.id
                ORDER BY s.gemeldet_am DESC
            `);
            
            const container = document.getElementById('schadensberichte');
            container.innerHTML = '';
            
            while (stmt.step()) {
                const s = stmt.getAsObject();
                const div = document.createElement('div');
                div.className = 'damage-report';
                
                const foto = s.foto ? `<img src="${s.foto}" style="max-width: 100px; border-radius: 5px; margin-top: 5px;">` : '';
                const statusBadge = s.status === 'offen' ? 
                    '<span class="badge badge-danger">Offen</span>' : 
                    '<span class="badge badge-success">Behoben</span>';
                
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>${s.name}</strong> (${s.inventarnummer}) ${statusBadge}
                            <p style="margin-top: 5px; font-size: 0.9em;">
                                <strong>Gemeldet von:</strong> ${s.mitarbeiter_name} am ${new Date(s.gemeldet_am).toLocaleString('de-DE')}
                            </p>
                            <p style="margin-top: 5px;">${s.beschreibung}</p>
                            ${foto}
                        </div>
                        ${s.status === 'offen' ? `
                        <div>
                            <button class="btn-success btn-small" onclick="resolveSchaden(${s.id}, ${s.werkzeug_id})">‚úì Behoben</button>
                        </div>
                        ` : ''}
                    </div>
                `;
                container.appendChild(div);
            }
            stmt.free();
            
            if (container.children.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Keine Schadensmeldungen</p>';
            }
        }
        
        function resolveSchaden(schadenId, werkzeugId) {
            if (!confirm('Schaden als behoben markieren? Die Schadensmeldung wird automatisch gel√∂scht.')) return;
            
            db.run("DELETE FROM schaeden WHERE id = ?", [schadenId]);
            db.run("UPDATE werkzeuge SET status = 'verfuegbar' WHERE id = ?", [werkzeugId]);
            
            if (saveDatabase()) {
                loadDashboard();
                loadAdminWerkzeuge();
                loadSchadensberichte();
                showToast('‚úì Schaden behoben und Meldung gel√∂scht!');
            }
        }
        
        function loadAlleAusleihen() {
            const stmt = db.prepare(`
                SELECT a.*, w.name, w.inventarnummer, w.lagerplatz 
                FROM ausleihen a 
                JOIN werkzeuge w ON a.werkzeug_id = w.id 
                ORDER BY a.reserviert_am DESC
            `);
            
            allAusleihenData = [];
            while (stmt.step()) {
                allAusleihenData.push(stmt.getAsObject());
            }
            stmt.free();
            
            renderAusleihen(allAusleihenData);
        }
        
        function renderAusleihen(ausleihen) {
            const tbody = document.getElementById('alleAusleihen');
            tbody.innerHTML = '';
            
            if (ausleihen.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color: #999;">Keine Ausleihen gefunden</td></tr>';
                return;
            }
            
            ausleihen.forEach(a => {
                const tr = document.createElement('tr');
                const overdue = isOverdue(a.datum_bis) && a.status !== 'zurueckgegeben';
                
                if (overdue) tr.classList.add('overdue');
                
                let statusBadge;
                if (a.status === 'reserviert') statusBadge = '<span class="badge badge-reserved">Reserviert</span>';
                else if (a.status === 'ausgeliehen') statusBadge = '<span class="badge badge-ausgeliehen">Ausgeliehen</span>';
                else statusBadge = '<span class="badge badge-returned">Zur√ºckgegeben</span>';
                
                if (overdue) {
                    statusBadge += ' <span class="badge badge-overdue">‚ö†Ô∏è √úberf√§llig</span>';
                }
                
                let history = '';
                if (a.reserviert_am) history += `<div class="history-item"><strong>Reserviert:</strong> ${new Date(a.reserviert_am).toLocaleString('de-DE')}</div>`;
                if (a.ausgeliehen_am) history += `<div class="history-item"><strong>Ausgegeben:</strong> ${new Date(a.ausgeliehen_am).toLocaleString('de-DE')}</div>`;
                if (a.zurueckgegeben_am) history += `<div class="history-item"><strong>Zur√ºckgegeben:</strong> ${new Date(a.zurueckgegeben_am).toLocaleString('de-DE')} (${a.rueckgabe_zustand})</div>`;
                
                let actions = '';
                if (a.status === 'reserviert') {
                    actions = `<button class="btn-success btn-small" onclick="ausgeben(${a.id})">‚úì Ausgeben</button> `;
                } else if (a.status === 'ausgeliehen') {
                    actions = `<button class="btn-warning btn-small" onclick="showRueckgabeModal(${a.id})">‚Ü© R√ºckgabe</button> `;
                }
                
                // Edit und Delete nur f√ºr aktive Buchungen (nicht zur√ºckgegeben)
                if (a.status !== 'zurueckgegeben') {
                    actions += `<button class="btn-secondary btn-small" onclick="showEditBuchungModal(${a.id})">‚úèÔ∏è</button> `;
                    actions += `<button class="btn-danger btn-small" onclick="showDeleteBuchungModal(${a.id}, '${escapeQuotes(a.name)}', '${escapeQuotes(a.mitarbeiter_name || 'Unbekannt')}')">üóëÔ∏è</button>`;
                }
                
                tr.innerHTML = `
                    <td><strong>${a.name}</strong><br><small>${a.inventarnummer}</small></td>
                    <td>${a.lagerplatz || '-'}</td>
                    <td>${a.mitarbeiter_name || '-'}</td>
                    <td>${formatDate(a.datum_von)} - ${formatDate(a.datum_bis)}</td>
                    <td>${statusBadge}</td>
                    <td style="font-size: 0.85em;">${history}</td>
                    <td>${actions}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function filterAusleihen() {
            const statusFilter = document.getElementById('filterStatus').value.toLowerCase();
            const mitarbeiterFilter = document.getElementById('filterMitarbeiter').value.toLowerCase();
            const werkzeugFilter = document.getElementById('filterWerkzeug').value.toLowerCase();
            
            const filtered = allAusleihenData.filter(a => {
                const matchStatus = !statusFilter || a.status === statusFilter;
                const matchMitarbeiter = !mitarbeiterFilter || (a.mitarbeiter_name && a.mitarbeiter_name.toLowerCase().includes(mitarbeiterFilter));
                const matchWerkzeug = !werkzeugFilter || a.name.toLowerCase().includes(werkzeugFilter) || a.inventarnummer.toLowerCase().includes(werkzeugFilter);
                
                return matchStatus && matchMitarbeiter && matchWerkzeug;
            });
            
            renderAusleihen(filtered);
        }
        
        function resetFilter() {
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterMitarbeiter').value = '';
            document.getElementById('filterWerkzeug').value = '';
            renderAusleihen(allAusleihenData);
        }
        
        function ausgeben(ausleiheId) {
            if (!confirm('Ausleihe best√§tigen und Werkzeug ausgeben?')) return;
            
            const now = new Date().toISOString();
            
            const stmt = db.prepare('SELECT werkzeug_id FROM ausleihen WHERE id = ?');
            stmt.bind([ausleiheId]);
            let werkzeugId = null;
            if (stmt.step()) {
                werkzeugId = stmt.getAsObject().werkzeug_id;
            }
            stmt.free();
            
            db.run("UPDATE ausleihen SET status = 'ausgeliehen', ausgeliehen_am = ? WHERE id = ?", [now, ausleiheId]);
            db.run("UPDATE werkzeuge SET status = 'ausgeliehen' WHERE id = ?", [werkzeugId]);
            
            if (saveDatabase()) {
                loadDashboard();
                // Filter beibehalten
                loadAlleAusleihen();
                filterAusleihen();
                loadAdminWerkzeuge();
                showToast('‚úì Werkzeug ausgegeben!');
            }
        }
        
        function showRueckgabeModal(ausleiheId) {
            document.getElementById('rueckgabeAusleiheId').value = ausleiheId;
            document.getElementById('rueckgabeZustand').value = 'OK';
            document.getElementById('rueckgabeKommentar').value = '';
            document.getElementById('rueckgabeModal').classList.add('active');
        }
        
        function confirmRueckgabe() {
            const ausleiheId = document.getElementById('rueckgabeAusleiheId').value;
            const zustand = document.getElementById('rueckgabeZustand').value;
            const kommentar = document.getElementById('rueckgabeKommentar').value.trim();
            const now = new Date().toISOString();
            
            const stmt = db.prepare('SELECT werkzeug_id FROM ausleihen WHERE id = ?');
            stmt.bind([ausleiheId]);
            let werkzeugId = null;
            if (stmt.step()) {
                werkzeugId = stmt.getAsObject().werkzeug_id;
            }
            stmt.free();
            
            db.run("UPDATE ausleihen SET status = 'zurueckgegeben', zurueckgegeben_am = ?, rueckgabe_zustand = ?, rueckgabe_kommentar = ? WHERE id = ?",
                [now, zustand, kommentar || null, ausleiheId]);
            db.run("UPDATE werkzeuge SET status = 'verfuegbar' WHERE id = ?", [werkzeugId]);
            
            if (saveDatabase()) {
                closeModal('rueckgabeModal');
                loadDashboard();
                // Filter beibehalten
                loadAlleAusleihen();
                filterAusleihen();
                loadAdminWerkzeuge();
                showToast('‚úì R√ºckgabe best√§tigt!');
            }
        }
        
        function showAddWerkzeugModal() {
            document.getElementById('werkzeugModalTitle').textContent = 'Werkzeug hinzuf√ºgen';
            document.getElementById('werkzeugId').value = '';
            document.getElementById('werkzeugName').value = '';
            document.getElementById('werkzeugKategorie').value = '';
            document.getElementById('werkzeugBeschreibung').value = '';
            document.getElementById('werkzeugInventarnummer').value = '';
            document.getElementById('werkzeugLagerplatz').value = '';
            document.getElementById('werkzeugZustand').value = 'Neu';
            document.getElementById('werkzeugFoto').value = '';
            document.getElementById('fotoPreview').innerHTML = '';
            document.getElementById('werkzeugModal').classList.add('active');
        }
        
        function editWerkzeug(id) {
            const stmt = db.prepare('SELECT * FROM werkzeuge WHERE id = ?');
            stmt.bind([id]);
            
            if (stmt.step()) {
                const w = stmt.getAsObject();
                document.getElementById('werkzeugModalTitle').textContent = 'Werkzeug bearbeiten';
                document.getElementById('werkzeugId').value = w.id;
                document.getElementById('werkzeugName').value = w.name;
                document.getElementById('werkzeugKategorie').value = w.kategorie || '';
                document.getElementById('werkzeugBeschreibung').value = w.beschreibung || '';
                document.getElementById('werkzeugInventarnummer').value = w.inventarnummer;
                document.getElementById('werkzeugLagerplatz').value = w.lagerplatz || '';
                document.getElementById('werkzeugZustand').value = w.zustand;
                
                const previewDiv = document.getElementById('fotoPreview');
                previewDiv.innerHTML = '';
                
                if (w.foto) {
                    const container = document.createElement('div');
                    container.className = 'foto-preview-container';
                    container.innerHTML = `
                        <img src="${w.foto}">
                        <button class="foto-remove-btn" onclick="removeFoto(); event.stopPropagation();" type="button">√ó</button>
                    `;
                    container.dataset.hasFoto = 'true';
                    previewDiv.appendChild(container);
                }
                
                document.getElementById('werkzeugModal').classList.add('active');
            }
            stmt.free();
        }
        
        function removeFoto() {
            const previewDiv = document.getElementById('fotoPreview');
            previewDiv.innerHTML = '';
            previewDiv.dataset.removeFoto = 'true';
        }
        
        function previewFoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > MAX_PHOTO_SIZE) {
                alert(`‚ö†Ô∏è Foto ist zu gro√ü (${(file.size / 1024 / 1024).toFixed(1)} MB). Maximal 2 MB empfohlen.`);
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    const maxWidth = 800;
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const compressed = canvas.toDataURL('image/jpeg', 0.8);
                    
                    const previewDiv = document.getElementById('fotoPreview');
                    const container = document.createElement('div');
                    container.className = 'foto-preview-container';
                    container.innerHTML = `
                        <img src="${compressed}">
                        <button class="foto-remove-btn" onclick="removeFoto(); event.stopPropagation();" type="button">√ó</button>
                        <p style="font-size: 0.85em; color: #999; margin-top: 5px;">
                            ${width}x${height}px, ~${(compressed.length / 1024).toFixed(0)} KB
                        </p>
                    `;
                    container.dataset.compressed = compressed;
                    
                    previewDiv.innerHTML = '';
                    previewDiv.appendChild(container);
                    delete previewDiv.dataset.removeFoto;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function saveWerkzeug() {
            const id = document.getElementById('werkzeugId').value;
            const name = document.getElementById('werkzeugName').value.trim();
            const kategorie = document.getElementById('werkzeugKategorie').value;
            const beschreibung = document.getElementById('werkzeugBeschreibung').value.trim();
            const inventarnummer = document.getElementById('werkzeugInventarnummer').value.trim();
            const lagerplatz = document.getElementById('werkzeugLagerplatz').value.trim();
            const zustand = document.getElementById('werkzeugZustand').value;
            
            const previewDiv = document.getElementById('fotoPreview');
            const container = previewDiv.querySelector('.foto-preview-container');
            const shouldRemoveFoto = previewDiv.dataset.removeFoto === 'true';
            
            let fotoBase64 = null;
            if (container && container.dataset.compressed) {
                fotoBase64 = container.dataset.compressed;
            }
            
            if (!name || !inventarnummer || !kategorie) {
                alert('‚ùå Name, Kategorie und Inventarnummer sind Pflichtfelder!');
                return;
            }
            
            try {
                if (id) {
                    if (shouldRemoveFoto) {
                        db.run('UPDATE werkzeuge SET name = ?, kategorie = ?, beschreibung = ?, inventarnummer = ?, lagerplatz = ?, zustand = ?, foto = NULL WHERE id = ?',
                            [name, kategorie || null, beschreibung, inventarnummer, lagerplatz || null, zustand, id]);
                    } else if (fotoBase64) {
                        db.run('UPDATE werkzeuge SET name = ?, kategorie = ?, beschreibung = ?, inventarnummer = ?, lagerplatz = ?, zustand = ?, foto = ? WHERE id = ?',
                            [name, kategorie || null, beschreibung, inventarnummer, lagerplatz || null, zustand, fotoBase64, id]);
                    } else {
                        db.run('UPDATE werkzeuge SET name = ?, kategorie = ?, beschreibung = ?, inventarnummer = ?, lagerplatz = ?, zustand = ? WHERE id = ?',
                            [name, kategorie || null, beschreibung, inventarnummer, lagerplatz || null, zustand, id]);
                    }
                } else {
                    db.run("INSERT INTO werkzeuge (name, kategorie, beschreibung, inventarnummer, lagerplatz, zustand, foto, status) VALUES (?, ?, ?, ?, ?, ?, ?, 'verfuegbar')",
                        [name, kategorie || null, beschreibung, inventarnummer, lagerplatz || null, zustand, fotoBase64 || null]);
                }
                
                if (saveDatabase()) {
                    closeModal('werkzeugModal');
                    loadAdminWerkzeuge();
                    loadKategorien();
                    showToast('‚úì Werkzeug gespeichert!');
                }
            } catch (e) {
                if (e.message.includes('UNIQUE constraint failed')) {
                    alert('‚ùå Inventarnummer existiert bereits!');
                } else {
                    alert('‚ùå Fehler: ' + e.message);
                }
            }
        }
        
        function showDeleteModal(id, name, inventarnummer) {
            document.getElementById('deleteWerkzeugId').value = id;
            document.getElementById('deleteWerkzeugInfo').textContent = `${name} (${inventarnummer})`;
            document.getElementById('deleteModal').classList.add('active');
        }
        
        function confirmDelete() {
            const id = document.getElementById('deleteWerkzeugId').value;
            
            const stmt = db.prepare('SELECT status FROM werkzeuge WHERE id = ?');
            stmt.bind([id]);
            let status = 'verfuegbar';
            if (stmt.step()) {
                status = stmt.getAsObject().status;
            }
            stmt.free();
            
            if (status !== 'verfuegbar' && status !== 'defekt') {
                alert('‚ùå Werkzeug kann nicht gel√∂scht werden (reserviert/ausgeliehen)!');
                closeModal('deleteModal');
                return;
            }
            
            try {
                db.run('DELETE FROM werkzeuge WHERE id = ?', [id]);
                if (saveDatabase()) {
                    closeModal('deleteModal');
                    loadDashboard();
                    loadAdminWerkzeuge();
                    showToast('‚úì Werkzeug gel√∂scht!');
                }
            } catch (e) {
                alert('‚ùå Fehler: ' + e.message);
            }
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }
        
        function importExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                
                let imported = 0;
                let errors = [];
                let duplicates = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const parts = parseCSVLine(line);
                    
                    if (parts.length >= 4) {
                        const [name, beschreibung, zustand, inventarnummer, kategorie] = parts;
                        
                        if (!name || !inventarnummer) {
                            errors.push(`Zeile ${i + 1}: Name/Inventarnummer fehlt`);
                            continue;
                        }
                        
                        try {
                            const stmt = db.prepare('SELECT id FROM werkzeuge WHERE inventarnummer = ?');
                            stmt.bind([inventarnummer]);
                            const exists = stmt.step();
                            stmt.free();
                            
                            if (!exists) {
                                db.run("INSERT INTO werkzeuge (name, kategorie, beschreibung, inventarnummer, zustand, status) VALUES (?, ?, ?, ?, ?, 'verfuegbar')",
                                    [name, kategorie || null, beschreibung || '', zustand || 'Neu', inventarnummer]);
                                imported++;
                            } else {
                                duplicates++;
                            }
                        } catch (e) {
                            errors.push(`Zeile ${i + 1}: ${e.message}`);
                        }
                    } else {
                        errors.push(`Zeile ${i + 1}: Nicht genug Spalten`);
                    }
                }
                
                if (saveDatabase()) {
                    loadDashboard();
                    loadAdminWerkzeuge();
                    loadKategorien();
                    
                    let message = `‚úÖ ${imported} Werkzeuge importiert!`;
                    if (duplicates > 0) message += `\n‚ö†Ô∏è ${duplicates} Duplikate √ºbersprungen`;
                    if (errors.length > 0) {
                        message += '\n\n‚ùå Fehler:\n' + errors.slice(0, 5).join('\n');
                        if (errors.length > 5) message += `\n... +${errors.length - 5} weitere`;
                    }
                    alert(message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function exportData() {
            const stmt = db.prepare('SELECT * FROM werkzeuge');
            const werkzeuge = [];
            while (stmt.step()) {
                werkzeuge.push(stmt.getAsObject());
            }
            stmt.free();
            
            let csv = 'Werkzeug,Beschreibung,Zustand,Inventarnummer,Kategorie,Lagerplatz,Status\n';
            werkzeuge.forEach(w => {
                const escapeCsv = (str) => {
                    str = String(str || '');
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                };
                csv += `${escapeCsv(w.name)},${escapeCsv(w.beschreibung)},${escapeCsv(w.zustand)},${escapeCsv(w.inventarnummer)},${escapeCsv(w.kategorie)},${escapeCsv(w.lagerplatz)},${w.status}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `werkzeuge_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('de-DE');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // Buchung bearbeiten
        function showEditBuchungModal(buchungId) {
            // Buchung laden
            const buchung = allAusleihenData.find(a => a.id === buchungId);
            if (!buchung) {
                alert('Buchung nicht gefunden!');
                return;
            }
            
            document.getElementById('editBuchungId').value = buchung.id;
            document.getElementById('editBuchungWerkzeugId').value = buchung.werkzeug_id;
            document.getElementById('editBuchungWerkzeug').textContent = `${buchung.name} (${buchung.inventarnummer})`;
            document.getElementById('editBuchungMitarbeiter').value = buchung.mitarbeiter_name || '';
            document.getElementById('editBuchungVon').value = buchung.datum_von;
            document.getElementById('editBuchungBis').value = buchung.datum_bis;
            document.getElementById('editBuchungOriginalVon').value = buchung.datum_von;
            document.getElementById('editBuchungOriginalBis').value = buchung.datum_bis;
            
            document.getElementById('editBuchungModal').classList.add('active');
        }
        
        function saveBuchungEdit() {
            const buchungId = parseInt(document.getElementById('editBuchungId').value);
            const werkzeugId = parseInt(document.getElementById('editBuchungWerkzeugId').value);
            const mitarbeiter = document.getElementById('editBuchungMitarbeiter').value.trim();
            const von = document.getElementById('editBuchungVon').value;
            const bis = document.getElementById('editBuchungBis').value;
            const originalVon = document.getElementById('editBuchungOriginalVon').value;
            const originalBis = document.getElementById('editBuchungOriginalBis').value;
            
            if (!mitarbeiter || !von || !bis) {
                alert('‚ùå Bitte alle Felder ausf√ºllen!');
                return;
            }
            
            if (new Date(bis) < new Date(von)) {
                alert('‚ùå "Bis"-Datum muss nach "Von"-Datum liegen!');
                return;
            }
            
            // Pr√ºfen ob Zeitraum ge√§ndert wurde
            const zeitraumGeaendert = von !== originalVon || bis !== originalBis;
            
            if (zeitraumGeaendert) {
                // Verf√ºgbarkeitspr√ºfung (ausgenommen die eigene Buchung)
                const stmt = db.prepare(`
                    SELECT COUNT(*) as count FROM ausleihen 
                    WHERE werkzeug_id = ? 
                    AND id != ?
                    AND status IN ('reserviert', 'ausgeliehen')
                    AND (
                        (datum_von <= ? AND datum_bis >= ?) OR
                        (datum_von >= ? AND datum_von <= ?) OR
                        (datum_bis >= ? AND datum_bis <= ?)
                    )
                `);
                stmt.bind([werkzeugId, buchungId, bis, von, von, bis, von, bis]);
                
                let conflicts = 0;
                if (stmt.step()) {
                    conflicts = stmt.getAsObject().count;
                }
                stmt.free();
                
                if (conflicts > 0) {
                    alert('‚ùå Werkzeug ist im gew√§hlten Zeitraum bereits reserviert oder ausgeliehen!');
                    return;
                }
            }
            
            // Buchung aktualisieren
            try {
                db.run('UPDATE ausleihen SET mitarbeiter_name = ?, datum_von = ?, datum_bis = ? WHERE id = ?',
                    [mitarbeiter, von, bis, buchungId]);
                
                if (saveDatabase()) {
                    closeModal('editBuchungModal');
                    loadAlleAusleihen();
                    filterAusleihen();
                    loadDashboard();
                    if (currentMode === 'admin') loadBuchungskalender();
                    showToast('‚úì Buchung aktualisiert!');
                }
            } catch (err) {
                alert('‚ùå Fehler beim Speichern: ' + err.message);
                console.error(err);
            }
        }
        
        function showDeleteBuchungModal(buchungId, werkzeugName, mitarbeiterName) {
            const buchung = allAusleihenData.find(a => a.id === buchungId);
            if (!buchung) {
                alert('Buchung nicht gefunden!');
                return;
            }
            
            document.getElementById('deleteBuchungId').value = buchung.id;
            document.getElementById('deleteBuchungWerkzeugId').value = buchung.werkzeug_id;
            document.getElementById('deleteBuchungInfo').textContent = `${werkzeugName} - ${mitarbeiterName} (${formatDate(buchung.datum_von)} - ${formatDate(buchung.datum_bis)})`;
            
            document.getElementById('deleteBuchungModal').classList.add('active');
        }
        
        function confirmBuchungDelete() {
            const buchungId = parseInt(document.getElementById('deleteBuchungId').value);
            const werkzeugId = parseInt(document.getElementById('deleteBuchungWerkzeugId').value);
            
            try {
                // Buchung l√∂schen
                db.run('DELETE FROM ausleihen WHERE id = ?', [buchungId]);
                
                // Werkzeugstatus pr√ºfen: Gibt es noch andere aktive Buchungen?
                const stmt = db.prepare('SELECT COUNT(*) as count FROM ausleihen WHERE werkzeug_id = ? AND status IN (?, ?)', [werkzeugId, 'reserviert', 'ausgeliehen']);
                let hasOtherBookings = false;
                if (stmt.step()) {
                    hasOtherBookings = stmt.getAsObject().count > 0;
                }
                stmt.free();
                
                // Werkzeugstatus zur√ºcksetzen wenn keine anderen Buchungen vorhanden
                if (!hasOtherBookings) {
                    db.run("UPDATE werkzeuge SET status = 'verfuegbar' WHERE id = ?", [werkzeugId]);
                }
                
                if (saveDatabase()) {
                    closeModal('deleteBuchungModal');
                    loadAlleAusleihen();
                    filterAusleihen();
                    loadDashboard();
                    loadAdminWerkzeuge();
                    if (currentMode === 'admin') loadBuchungskalender();
                    showToast('‚úì Buchung gel√∂scht!');
                }
            } catch (err) {
                alert('‚ùå Fehler beim L√∂schen: ' + err.message);
                console.error(err);
            }
        }
        
        // Buchungskalender
        function showWerkzeugverwaltung() {
            document.getElementById('werkzeugverwaltungView').classList.remove('hidden');
            document.getElementById('buchungskalenderView').classList.add('hidden');
        }
        
        function showBuchungskalender() {
            document.getElementById('werkzeugverwaltungView').classList.add('hidden');
            document.getElementById('buchungskalenderView').classList.remove('hidden');
            
            // Jahr-Dropdown bef√ºllen (aktuelles Jahr ¬± 2 Jahre)
            const heute = new Date();
            const aktuellesJahr = heute.getFullYear();
            const jahrSelect = document.getElementById('kalenderJahr');
            jahrSelect.innerHTML = '';
            
            for (let jahr = aktuellesJahr - 2; jahr <= aktuellesJahr + 2; jahr++) {
                const option = document.createElement('option');
                option.value = jahr;
                option.textContent = jahr;
                if (jahr === aktuellesJahr) option.selected = true;
                jahrSelect.appendChild(option);
            }
            
            // Aktuellen Monat setzen
            document.getElementById('kalenderMonat').value = heute.getMonth();
            
            // Werkzeuge f√ºr Filter laden (nach Inventarnummer sortiert)
            const select = document.getElementById('kalenderWerkzeugFilter');
            select.innerHTML = '<option value="">Alle Werkzeuge</option>';
            
            const stmt = db.prepare('SELECT id, name, inventarnummer FROM werkzeuge ORDER BY inventarnummer');
            while (stmt.step()) {
                const w = stmt.getAsObject();
                const option = document.createElement('option');
                option.value = w.id;
                option.textContent = `${w.inventarnummer} - ${w.name}`;
                select.appendChild(option);
            }
            stmt.free();
            
            loadBuchungskalender();
        }
        
        function resetKalenderFilter() {
            const heute = new Date();
            document.getElementById('kalenderJahr').value = heute.getFullYear();
            document.getElementById('kalenderMonat').value = heute.getMonth();
            document.getElementById('kalenderWerkzeugFilter').value = '';
            
            loadBuchungskalender();
        }
        
        function loadBuchungskalender() {
            const jahr = parseInt(document.getElementById('kalenderJahr').value);
            const monat = parseInt(document.getElementById('kalenderMonat').value);
            const werkzeugFilter = document.getElementById('kalenderWerkzeugFilter').value;
            
            // Erster und letzter Tag des Monats
            const startDate = new Date(jahr, monat, 1);
            const endDate = new Date(jahr, monat + 1, 0); // Letzter Tag des Monats
            
            const daysInMonth = endDate.getDate();
            
            // Werkzeuge laden
            let werkzeugeQuery = 'SELECT * FROM werkzeuge';
            const params = [];
            
            if (werkzeugFilter) {
                werkzeugeQuery += ' WHERE id = ?';
                params.push(werkzeugFilter);
            }
            
            werkzeugeQuery += ' ORDER BY inventarnummer';
            
            const werkzeugeStmt = db.prepare(werkzeugeQuery);
            werkzeugeStmt.bind(params);
            
            const werkzeuge = [];
            while (werkzeugeStmt.step()) {
                werkzeuge.push(werkzeugeStmt.getAsObject());
            }
            werkzeugeStmt.free();
            
            if (werkzeuge.length === 0) {
                document.getElementById('kalenderContainer').innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Keine Werkzeuge gefunden</p>';
                return;
            }
            
            // Ausleihen/Reservierungen im Monat laden
            const vonStr = startDate.toISOString().split('T')[0];
            const bisStr = endDate.toISOString().split('T')[0];
            
            const ausleihenStmt = db.prepare(`
                SELECT * FROM ausleihen 
                WHERE status IN ('reserviert', 'ausgeliehen', 'zurueckgegeben')
                AND (
                    (datum_von <= ? AND datum_bis >= ?) OR
                    (datum_von >= ? AND datum_von <= ?) OR
                    (datum_bis >= ? AND datum_bis <= ?)
                )
            `);
            
            ausleihenStmt.bind([bisStr, vonStr, vonStr, bisStr, vonStr, bisStr]);
            
            const ausleihen = [];
            while (ausleihenStmt.step()) {
                ausleihen.push(ausleihenStmt.getAsObject());
            }
            ausleihenStmt.free();
            
            // Kalender rendern
            renderKalender(werkzeuge, ausleihen, startDate, endDate, daysInMonth);
        }
        
        function renderKalender(werkzeuge, ausleihen, startDate, endDate, days) {
            const container = document.getElementById('kalenderContainer');
            const heute = new Date();
            heute.setHours(0, 0, 0, 0);
            
            // Buchungen pro Werkzeug und Tag organisieren
            const buchungenMap = new Map();
            werkzeuge.forEach(w => {
                buchungenMap.set(w.id, new Map());
            });
            
            ausleihen.forEach(a => {
                if (!buchungenMap.has(a.werkzeug_id)) return;
                
                const vonDate = new Date(a.datum_von);
                const bisDate = new Date(a.datum_bis);
                
                // F√ºr jeden Tag in der Buchung
                for (let d = new Date(vonDate); d <= bisDate; d.setDate(d.getDate() + 1)) {
                    const dayKey = d.toISOString().split('T')[0];
                    const werkzeugMap = buchungenMap.get(a.werkzeug_id);
                    
                    if (!werkzeugMap.has(dayKey)) {
                        werkzeugMap.set(dayKey, []);
                    }
                    werkzeugMap.get(dayKey).push(a);
                }
            });
            
            // Table bauen
            let html = '<div class="kalender-wrapper">';
            html += '<table class="kalender-table">';
            
            // Header
            html += '<thead><tr>';
            html += '<th>Werkzeug</th>';
            
            for (let i = 0; i < days; i++) {
                const day = new Date(startDate);
                day.setDate(startDate.getDate() + i);
                
                const isToday = day.getTime() === heute.getTime();
                const dayStr = day.getDate();
                const weekdayShort = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'][day.getDay()];
                
                html += `<th class="${isToday ? 'today' : ''}">`;
                html += `<span class="kalender-day-header">${weekdayShort}</span>`;
                html += `<span class="kalender-day-number">${dayStr}</span>`;
                html += `</th>`;
            }
            
            html += '</tr></thead>';
            
            // Body: Werkzeug-Rows
            html += '<tbody>';
            
            werkzeuge.forEach(w => {
                html += '<tr>';
                html += `<td>`;
                html += `<span class="kalender-werkzeug-name">${w.name}</span>`;
                html += `<span class="kalender-werkzeug-inv">${w.inventarnummer}</span>`;
                html += `</td>`;
                
                const werkzeugMap = buchungenMap.get(w.id);
                
                for (let i = 0; i < days; i++) {
                    const day = new Date(startDate);
                    day.setDate(startDate.getDate() + i);
                    const dayKey = day.toISOString().split('T')[0];
                    
                    const isToday = day.getTime() === heute.getTime();
                    const isWeekend = day.getDay() === 0 || day.getDay() === 6;
                    
                    const buchungen = werkzeugMap.get(dayKey) || [];
                    
                    let cellClass = '';
                    if (isToday) cellClass += 'today ';
                    if (isWeekend && !isToday) cellClass += 'weekend ';
                    
                    html += `<td class="${cellClass}">`;
                    
                    if (buchungen.length > 0) {
                        // Zeige erste Buchung (h√∂chste Priorit√§t: ausgeliehen > reserviert > zurueckgegeben)
                        const sortedBuchungen = buchungen.sort((a, b) => {
                            const priority = { 'ausgeliehen': 1, 'reserviert': 2, 'zurueckgegeben': 3 };
                            return priority[a.status] - priority[b.status];
                        });
                        
                        const buchung = sortedBuchungen[0];
                        const mitarbeiter = buchung.mitarbeiter_name || '?';
                        const initials = mitarbeiter.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                        const title = `${mitarbeiter}\n${formatDate(buchung.datum_von)} - ${formatDate(buchung.datum_bis)}`;
                        
                        html += `<div class="kalender-cell-content ${buchung.status}" title="${escapeQuotes(title)}">${initials}</div>`;
                    }
                    
                    html += `</td>`;
                }
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            html += '</table>';
            html += '</div>';
            
            // Legende
            html += '<div class="kalender-legend">';
            html += '<div class="kalender-legend-item">';
            html += '<div class="kalender-legend-box reserviert"></div>';
            html += '<span>Reserviert</span>';
            html += '</div>';
            html += '<div class="kalender-legend-item">';
            html += '<div class="kalender-legend-box ausgeliehen"></div>';
            html += '<span>Ausgeliehen</span>';
            html += '</div>';
            html += '<div class="kalender-legend-item">';
            html += '<div class="kalender-legend-box zurueckgegeben"></div>';
            html += '<span>Zur√ºckgegeben</span>';
            html += '</div>';
            html += '</div>';
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>
